{% extends "monitoreo/base.html" %}

{% block title %}Estad√≠sticas - Sistema de Monitoreo{% endblock %}
{% block page_title %}Dashboard de Estad√≠sticas y An√°lisis{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para estad√≠sticas */
    .stats-filters {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-input,
    .form-select {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .form-select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231e3a8a' d='M1 4l5 5 5-5'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        padding-right: 2rem;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .action-btn {
        padding: 0.75rem 1.5rem;
        background: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        width: 100%;
    }

    .action-btn:hover {
        background: var(--primary-color);
        transform: translateY(-2px);
    }

    /* Tarjetas de resumen */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .summary-card {
        background: white;
        padding: 1.8rem;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-top: 5px solid var(--secondary-color);
        text-align: center;
        min-height: 160px;
        transition: all 0.3s ease;
    }

    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .summary-card.danger {
        border-top-color: var(--danger-color);
    }

    .summary-card.warning {
        border-top-color: var(--warning-color);
    }

    .summary-card.success {
        border-top-color: var(--success-color);
    }

    .card-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary-color);
        margin-bottom: 0.3rem;
    }

    .card-label {
        font-size: 1.1rem;
        text-transform: uppercase;
        color: var(--text-light);
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .card-trend {
        font-size: 0.95rem;
        font-weight: 600;
    }

    .card-trend.negative {
        color: var(--danger-color);
    }

    /* Secci√≥n de gr√°ficos */
    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .chart-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    /* Gr√°fico de barras */
    .bar-chart {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .bar-item {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .bar-label {
        min-width: 150px;
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .bar-container {
        flex: 1;
        height: 30px;
        background: var(--light-bg);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 0.5rem;
        color: white;
        font-size: 0.75rem;
        font-weight: 700;
        transition: width 0.5s ease;
    }

    .bar-fill.danger {
        background: linear-gradient(90deg, var(--danger-color) 0%, #b91c1c 100%);
    }

    .bar-fill.warning {
        background: linear-gradient(90deg, var(--warning-color) 0%, #d97706 100%);
    }

    .bar-fill.success {
        background: linear-gradient(90deg, var(--success-color) 0%, #059669 100%);
    }

    .bar-value {
        min-width: 60px;
        text-align: right;
        font-weight: 700;
        color: var(--primary-color);
        font-size: 0.95rem;
    }

    /* Pie chart simulado */
    .pie-chart {
        width: 250px;
        height: 250px;
        border-radius: 50%;
        background: conic-gradient(
            var(--danger-color) 0deg {{ severidad.critica|floatformat:0 }}deg,
            var(--warning-color) {{ severidad.critica|floatformat:0 }}deg calc({{ severidad.critica|floatformat:0 }}deg + {{ severidad.alta|floatformat:0 }}deg),
            var(--success-color) calc({{ severidad.critica|floatformat:0 }}deg + {{ severidad.alta|floatformat:0 }}deg) 360deg
        );
        margin: 1rem auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .pie-legend {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
        text-align: center;
        margin-top: 1.5rem;
    }

    .pie-item {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.85rem;
    }

    .pie-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }

    /* Tabla de zonas */
    .zones-table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .table-header {
        padding: 1.5rem;
        background: var(--light-bg);
        border-bottom: 2px solid var(--border-color);
    }

    .table-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .table-wrapper {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: var(--light-bg);
        border-bottom: 2px solid var(--border-color);
    }

    th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
    }

    tbody tr:hover {
        background: rgba(59, 130, 246, 0.05);
    }

    /* Badges */
    .zone-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-high {
        background: rgba(220, 38, 38, 0.1);
        color: var(--danger-color);
    }

    .badge-medium {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .badge-low {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
    }

    /* Tendencia */
    .trend-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .trend-up {
        color: var(--danger-color);
    }

    .trend-down {
        color: var(--success-color);
    }

    .trend-stable {
        color: var(--text-light);
    }

    /* Insights section */
    .insights-section {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .insights-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .insight-item {
        padding: 1rem;
        background: var(--light-bg);
        border-left: 4px solid var(--secondary-color);
        border-radius: 6px;
    }

    .insight-item.critical {
        border-left-color: var(--danger-color);
    }

    .insight-item.warning {
        border-left-color: var(--warning-color);
    }

    .insight-title {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }

    .insight-description {
        font-size: 0.9rem;
        color: var(--text-dark);
    }

    /* Estado vac√≠o */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }

    .empty-description {
        color: var(--text-light);
    }

    /* Responsividad */
    @media (max-width: 1024px) {
        .charts-section {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .stats-filters {
            grid-template-columns: 1fr;
        }

        .summary-cards {
            grid-template-columns: 1fr 1fr;
        }

        table {
            font-size: 0.8rem;
        }

        th, td {
            padding: 0.75rem;
        }
    }

    @media (max-width: 480px) {
        .summary-cards {
            grid-template-columns: 1fr;
        }

        .card-value {
            font-size: 1.75rem;
        }

        .pie-chart {
            width: 200px;
            height: 200px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="animate-fade">
    <!-- Filtros para estad√≠sticas -->
    <form method="get" class="stats-filters">
        <div class="filter-group">
            <label class="filter-label">üìÖ Rango de Fechas</label>
            <select class="form-select" name="rango">
                <option value="today" {% if rango_seleccionado == 'today' %}selected{% endif %}>Hoy</option>
                <option value="week" {% if rango_seleccionado == 'week' %}selected{% endif %}>Esta semana</option>
                <option value="month" {% if rango_seleccionado == 'month' or not rango_seleccionado %}selected{% endif %}>Este mes</option>
                <option value="year" {% if rango_seleccionado == 'year' %}selected{% endif %}>Este a√±o</option>
            </select>
        </div>

        <div class="filter-group">
            <label class="filter-label">üìä Tipo de An√°lisis</label>
            <select class="form-select" name="tipo">
                <option value="all" {% if tipo_seleccionado == 'all' or not tipo_seleccionado %}selected{% endif %}>Todos los eventos</option>
                <option value="suspicious" {% if tipo_seleccionado == 'suspicious' %}selected{% endif %}>Solo sospechosos</option>
                <option value="normal" {% if tipo_seleccionado == 'normal' %}selected{% endif %}>Solo normales</option>
            </select>
        </div>

        <button type="submit" class="action-btn">
            üìä Actualizar An√°lisis
        </button>
    </form>

    <!-- Resumen de estad√≠sticas principales -->
    <div class="summary-cards">
        <div class="summary-card">
            <div class="card-value">{{ resumen.total_eventos }}</div>
            <div class="card-label">Total Eventos</div>
            <div class="card-trend">Periodo seleccionado</div>
        </div>

        <div class="summary-card danger">
            <div class="card-value">{{ resumen.eventos_sospechosos }}</div>
            <div class="card-label">Eventos Sospechosos</div>
            <div class="card-trend negative">Alta y Media severidad</div>
        </div>

        <div class="summary-card success">
            <div class="card-value">{{ resumen.eventos_normales }}</div>
            <div class="card-label">Eventos Normales</div>
            <div class="card-trend">Baja severidad</div>
        </div>

        <div class="summary-card warning">
            <div class="card-value">{{ resumen.tasa_resolucion }}</div>
            <div class="card-label">Tasa de Resoluci√≥n</div>
            <div class="card-trend">Eventos activos</div>
        </div>
    </div>

    {% if resumen.total_eventos > 0 %}
    <!-- Gr√°ficos -->
    <div class="charts-section">
        <!-- Eventos por ubicaci√≥n/ciudad -->
        <div class="chart-card">
            <div class="chart-title">üìä Eventos por Ubicaci√≥n</div>
            <div class="bar-chart">
                {% for zona_key, zona in zonas.items %}
                <div class="bar-item">
                    <div class="bar-label">{{ zona.nombre }}</div>
                    <div class="bar-container">
                        <div class="bar-fill
                            {% if zona.riesgo == 'Cr√≠tico' %}danger
                            {% elif zona.riesgo == 'Alto' or zona.riesgo == 'Medio' %}warning
                            {% else %}success{% endif %}"
                            style="width: {% if resumen.total_eventos > 0 %}{% widthratio zona.eventos resumen.total_eventos 100 %}{% else %}0{% endif %}%;">
                            {{ zona.eventos }}
                        </div>
                    </div>
                    <div class="bar-value">{{ zona.eventos }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Distribuci√≥n de severidad -->
        <div class="chart-card">
            <div class="chart-title">üéØ Distribuci√≥n de Severidad</div>
            <div style="text-align: center;">
                <div class="pie-chart"></div>
                <div class="pie-legend">
                    <div class="pie-item">
                        <div class="pie-color" style="background: var(--danger-color);"></div>
                        <span>Cr√≠tica ({{ severidad.critica }}%)</span>
                    </div>
                    <div class="pie-item">
                        <div class="pie-color" style="background: var(--warning-color);"></div>
                        <span>Alta ({{ severidad.alta }}%)</span>
                    </div>
                    <div class="pie-item">
                        <div class="pie-color" style="background: var(--success-color);"></div>
                        <span>Normal ({{ severidad.normal }}%)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de ubicaciones con estad√≠sticas -->
    <div class="zones-table-container">
        <div class="table-header">
            <div class="table-title">üìä Estad√≠sticas Detalladas por Ubicaci√≥n</div>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>üìç Ubicaci√≥n</th>
                        <th>Total Eventos</th>
                        <th>Sospechosos</th>
                        <th>Normales</th>
                        <th>Nivel de Riesgo</th>
                        <th>Tendencia</th>
                    </tr>
                </thead>
                <tbody>
                    {% for zona_key, zona in zonas.items %}
                    <tr>
                        <td><strong>{{ zona.nombre }}</strong></td>
                        <td>{{ zona.eventos }}</td>
                        <td style="color: var(--danger-color); font-weight: 600;">{{ zona.sospechosos }}</td>
                        <td style="color: var(--success-color); font-weight: 600;">{{ zona.normales }}</td>
                        <td>
                            <span class="zone-badge {{ zona.badge_class }}">
                                {{ zona.riesgo }}
                            </span>
                        </td>
                        <td>
                            <div class="trend-indicator
                                {% if zona.tendencia == 'up' %}trend-up
                                {% elif zona.tendencia == 'down' %}trend-down
                                {% else %}trend-stable{% endif %}">
                                {% if zona.tendencia == 'up' %}
                                    ‚¨Ü Aumento
                                {% elif zona.tendencia == 'down' %}
                                    ‚¨á Disminuci√≥n
                                {% else %}
                                    ‚ûñ Estable
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Insights y Recomendaciones -->
    <div class="insights-section">
        <div class="insights-title">üí° Insights y Recomendaciones</div>
        <div class="insights-grid">
            {% for zona_key, zona in zonas.items %}
                {% if zona.riesgo == 'Cr√≠tico' or zona.riesgo == 'Alto' %}
                <div class="insight-item {% if zona.riesgo == 'Cr√≠tico' %}critical{% else %}warning{% endif %}">
                    <div class="insight-title">
                        {% if zona.riesgo == 'Cr√≠tico' %}‚ö†Ô∏è{% else %}üìà{% endif %}
                        {{ zona.nombre }} requiere atenci√≥n
                    </div>
                    <div class="insight-description">
                        Registra {{ zona.sospechosos }} eventos sospechosos de {{ zona.eventos }} totales.
                        {% if zona.tendencia == 'up' %}
                        Se observa una tendencia al alza en esta ubicaci√≥n.
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}

            <div class="insight-item">
                <div class="insight-title">üìä Eficiencia de detecci√≥n</div>
                <div class="insight-description">
                    El sistema ha detectado {{ resumen.eventos_sospechosos }} eventos sospechosos de {{ resumen.total_eventos }} totales ({{ severidad.critica|add:severidad.alta }}%).
                </div>
            </div>

            <div class="insight-item">
                <div class="insight-title">‚úì Tasa de resoluci√≥n</div>
                <div class="insight-description">
                    {{ resumen.tasa_resolucion }} de las alertas han sido marcadas como activas/resueltas.
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Estado vac√≠o -->
    <div class="empty-state">
        <div class="empty-icon">üìä</div>
        <h2 class="empty-title">No hay datos disponibles</h2>
        <p class="empty-description">
            No se encontraron eventos en el periodo seleccionado.
            Prueba ajustando los filtros para ver m√°s informaci√≥n.
        </p>
    </div>
    {% endif %}
</div>

<!-- JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Dashboard de Estad√≠sticas inicializado');
        console.log('RF-06: Visualizar estad√≠sticas por zonas - Dashboard activo');
        console.log('Total eventos:', {{ resumen.total_eventos }});
    });
</script>
{% endblock %}